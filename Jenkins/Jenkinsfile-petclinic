pipeline {
  agent any
  parameters {
    string(name: 'projectName', defaultValue: 'psapp', description: 'Project name to create or target for update')
  }

  stages {
    stage('Create project') {
    steps {
        sh """cd openshift
oc login https://localhost:8443 --username developer --password developer --insecure-skip-tls-verify=true
if ! oc project ${projectName}
then
  oc new-project ${projectName}
fi"""
      }
    }
    stage('Create Maven image stream and get image') {
      steps {
        sh """cd openshift
oc login https://localhost:8443 --username developer --password developer --insecure-skip-tls-verify=true
oc project ${projectName}
oc apply -f pcmvn-imagestream.yaml
oc import-image maven --from=docker.io/maven:3.6.3-jdk-11 --confirm"""
      }
    }
    stage('Build add or update Petclinic configuration') {
      steps {
        sh """cd openshift
oc login https://localhost:8443 --username developer --password developer --insecure-skip-tls-verify=true
oc project ${projectName}
oc apply -f petclinic-imagestream.yaml
oc apply -f petclinic-build.yaml
oc apply -f petclinic-service.yaml
oc apply -f petclinic-route.yaml"""
        }
    }
    stage('Build Petclinic image') {
      steps {
        sh """oc login https://localhost:8443 --username developer --password developer --insecure-skip-tls-verify=true
oc start-build petclinic"""
      }
    }
    stage('Deploy PetcClinic Container To Openshift') {
      steps {
        sh """cd openshift
oc login https://localhost:8443 --username developer --password developer --insecure-skip-tls-verify=true
oc project ${projectName}
oc apply -f petclinic-deploymentconfig.yaml"""
      }
    }
  }
}
